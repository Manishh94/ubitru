function MMBoxWidget(e){this.engine=e,this.messages=[],this.numListingsToDisplay=3,this.isExpanded=!1,this.currentSearchText="",this.currentData=[],this.widget=$("#mm-box-container"),this.listingsTable=$(".mm-listings"),this.currentXhr=null,$("#mm-info-before-shopping").center(),this.bindListeners()}MMBoxWidget.prototype.bindListeners=function(){var e=this;$(".mm_data_company_name").trunk8(),$(".mm_data_company_address").trunk8(),$(".mm_data_offer_name").trunk8({lines:2}),$(".mm_data_coupon_code").trunk8({width:10});var t=$.proxy(function(){this.engine.get("icons","isPopupVisible")||this.showMoreOffers()},this);$("#mm-next-offers-btn").click(t),$("#mm-clear-message-button").click(function(){$.post(e.engine.urlFor("/mm_box_remove_user_message"),{id:e.messages[0].id},function(t){t&&(e.messages.shift(),e.messages.length>0?$("#mm-current-message").html(e.messages[0].message):$("#mm-box-message-container").slideUp())})}),isMobile()&&$(window).on("shake",t)},MMBoxWidget.prototype.clearResults=function(){$(".mm-listing").remove(),this.isExpanded=!1,$("#mm-next-offers-label").text("More Deals"),this.currentData=[],this.listingsTable.fadeOut()},MMBoxWidget.prototype.onCheckUserMessages=function(){0==this.messages.length&&$.get(this.engine.urlFor("/mm_box_get_user_messages"),$.proxy(function(e){if(e&&e.length){this.messages=e,console.log(this.messages);var t=$("#mm-box-message-container");t.is(":hidden")&&($("#mm-current-message").html(this.messages[0].message),t.slideDown())}},this))},MMBoxWidget.prototype.setSearchText=function(e){this.engine.isUserLoggedIn&&""!=e&&e!=this.currentSearchText&&(this.clearResults(),this.currentSearchText=e,this.loadMerchantsData())},MMBoxWidget.prototype.loadMerchantsData=function(){this.currentXhr&&this.currentXhr.abort(),this.currentXhr=$.get(this.engine.urlFor("/mm_box_search"),{search:this.currentSearchText},$.proxy(function(e){this.appendData(e,!0),this.currentXhr=null},this))},MMBoxWidget.prototype.appendData=function(e,t){this.currentData=t?e.concat(this.currentData):this.currentData.concat(e),this.currentData=uniqueBy(this.currentData,function(e){return e.company_name}),this.currentData.length&&(this.listingsTable.fadeIn(),this.buildListings(),this.calculateTotalMoney())},MMBoxWidget.prototype.buildListings=function(){for(var e=0;e<this.currentData.length;e++){var t=this.currentData[e],i="mm-listing-"+t.id,n=$("#"+i);if(0==n.length){var s=$("#mm-listing-template");n=s.clone(!0).addClass("mm-listing"),n.attr("id",i),s.closest("tbody").append(n)}e<this.numListingsToDisplay||this.isExpanded?n.removeClass("hide"):n.addClass("hide");for(var a in t)n.find(".mm_data_"+a).html(t[a]);if(n.find(".mm_data_company_name").trunk8("update",t.company_name.replace("Affiliate Program","")),t.company_address&&n.find(".mm_data_company_address").trunk8("update",t.company_address),n.find(".mm_data_offer_name").trunk8("update",t.offer_name),n.find(".mm_data_coupon_code").trunk8("update",t.coupon_code),t.offer_buy_url)n.find(".mm-shop-now-btn, .mm_data_company_name").attr("mm-href",t.offer_buy_url),n.find(".mm_data_company_name").addClass("mm-active-link").end().find(".mm-shop-now-btn").removeClass("hide"),"No coupons"!=t.coupon_code&&n.find(".mm_data_coupon_code").addClass("mm-active-link").end().find(".mm_data_company_name, .mm_data_coupon_code, .mm-shop-now-btn").attr("mm-href-popup",t.company_coupons_url);else if(isMobile()?(n.find(".mm-call-now-btn").attr("href","tel:"+t.company_phone),n.find(".mm-call-now-btn").removeClass("hide").html(t.company_phone)):(n.find(".mm-call-now-btn").attr({tooltip:t.company_phone}),n.find(".mm-call-now-btn").tipsy({title:"tooltip"}),n.find(".mm-call-now-btn").removeClass("hide").html("view number")),t.merchant_email){n.find(".mm_data_company_name").addClass("mm-active-link").attr("data-toggle","modal").attr("href","#mm-merchant-modal");var o=this;n.find(".mm_data_company_name").click(function(){for(var e=$(this).parent().parent(),t=e.attr("id").replace("mm-listing-",""),i=null,n=0;n<o.currentData.length;n++)if(t==o.currentData[n].id){i=o.currentData[n];break}for(var s in i)$("#mm-merchant-modal").find(".mm_data_"+s).html(i[s]);$("#mm-merchant-modal").find(".mm_data_merchant_email").html("Email: "+i.merchant_email).end().find(".mm_data_company_phone").html("Phone: "+i.company_phone).end().find(".mm_data_merchant_review_url").attr("href",i.merchant_review_url).end().find(".mm_data_offer_service_url").attr("href",i.offer_service_url)})}if(!isNaN(t.user_money)){var r=parseFloat(t.user_money);n.find(".mm_data_user_money").html(formatMoney(r))}n.find("[mm-href], .mm-call-now-btn").attr("mm-merchant-id",t.id)}},MMBoxWidget.prototype.calculateTotalMoney=function(){for(var e=0,t=0;t<this.currentData.length;t++){var i=this.currentData[t];isNaN(i.user_money)||(e+=parseFloat(i.user_money))}$("#mm-total-money").html("Your Cash Total: "+formatMoney(e))},MMBoxWidget.prototype.showMoreOffers=function(){this.isExpanded=!this.isExpanded,$("#mm-next-offers-label").text(this.isExpanded?"Show Less":"More Deals"),this.buildListings()},MMBoxWidget.prototype.getCurrentData=function(){return this.currentData},MMBoxWidget.prototype.getSearchString=function(){return this.currentSearchText},MMBoxWidget.prototype.onUserLoggedIn=function(e){$("#mm_user_balance").html(formatMoney(e.balance)),$("#mm_user_score").html(e.score),$("#mm-box-controls-logged-in").removeClass("hide"),$("#mm-box-controls-not-logged-in").addClass("hide")},MMBoxWidget.prototype.onUserLoggedOut=function(){this.currentXhr&&this.currentXhr.abort(),this.messages=[],$("#mm-box-message-container").slideUp(),$("#mm_user_score").html("--"),$("#mm-box-controls-logged-in").addClass("hide"),$("#mm-box-controls-not-logged-in").removeClass("hide"),this.currentSearchText="",this.clearResults()};