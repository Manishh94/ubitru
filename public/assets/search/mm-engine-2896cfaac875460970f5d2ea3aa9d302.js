function MMBoxWidget(e){this.engine=e,this.messages=[],this.numListingsToDisplay=3,this.isExpanded=!1,this.currentSearchText="",this.currentData=[],this.widget=$("#mm-box-container"),this.listingsTable=$(".mm-listings"),this.currentXhr=null,$("#mm-info-before-shopping").center(),this.bindListeners()}function MMIconsWidget(e){this.engine=e,this.searchEngineLinkContainers=null,this.currentXhr=null,this.bindListeners(),this.currentOfferIndex=0}function MMEngine(e,t,i,n){this.BASE_URL=e||"",this.currentUserInfo=t,this.isUserLoggedIn=null!=t,this.skipInfoBeforeShopping=!1;var s=$(".mm-search-bar-icon").addClass(n).removeClass("hide");$("."+i).each($.proxy(function(e,t){$(t).append(e?s.clone():s)},this)),this.bindListeners(),this.widgets={box:new MMBoxWidget(this),icons:new MMIconsWidget(this)},this.currentMerchantId=null,this.currentShoppingHref=null}MMBoxWidget.prototype.bindListeners=function(){var e=this;$(".mm_data_company_name").trunk8(),$(".mm_data_company_address").trunk8(),$(".mm_data_offer_name").trunk8({lines:2}),$(".mm_data_coupon_code").trunk8({width:10}),isMobile()||$(".mm-call-now-btn").tipsy({title:"tooltip"});var t=$.proxy(function(){this.engine.get("icons","isPopupVisible")||this.showMoreOffers()},this);$("#mm-next-offers-btn").click(t),$("#mm-clear-message-button").click(function(){$.post(e.engine.urlFor("/mm_box_remove_user_message"),{id:e.messages[0].id},function(t){t&&(e.messages.shift(),e.messages.length>0?$("#mm-current-message").html(e.messages[0].message):$("#mm-box-message-container").slideUp())})}),isMobile()&&$(window).on("shake",t)},MMBoxWidget.prototype.clearResults=function(){$(".mm-listing").remove(),this.isExpanded=!1,$("#mm-next-offers-label").text("More Deals"),this.currentData=[],this.listingsTable.fadeOut()},MMBoxWidget.prototype.onCheckUserMessages=function(){0==this.messages.length&&$.get(this.engine.urlFor("/mm_box_get_user_messages"),$.proxy(function(e){if(e&&e.length){this.messages=e,console.log(this.messages);var t=$("#mm-box-message-container");t.is(":hidden")&&($("#mm-current-message").html(this.messages[0].message),t.slideDown())}},this))},MMBoxWidget.prototype.setSearchText=function(e){this.engine.isUserLoggedIn&&""!=e&&e!=this.currentSearchText&&(this.clearResults(),this.currentSearchText=e,this.loadMerchantsData())},MMBoxWidget.prototype.loadMerchantsData=function(){this.currentXhr&&this.currentXhr.abort(),this.currentXhr=$.get(this.engine.urlFor("/mm_box_search"),{search:this.currentSearchText},$.proxy(function(e){this.appendData(e,!0),this.currentXhr=null},this))},MMBoxWidget.prototype.appendData=function(e,t){this.currentData=t?e.concat(this.currentData):this.currentData.concat(e),this.currentData=uniqueBy(this.currentData,function(e){return e.company_name}),this.currentData.length&&(this.listingsTable.fadeIn(),this.buildListings(),this.calculateTotalMoney())},MMBoxWidget.prototype.buildListings=function(){for(var e=0;e<this.currentData.length;e++){var t=this.currentData[e],i="mm-listing-"+t.id,n=$("#"+i);if(0==n.length){var s=$("#mm-listing-template");n=s.clone(!0).addClass("mm-listing"),n.attr("id",i),s.closest("tbody").append(n)}e<this.numListingsToDisplay||this.isExpanded?n.removeClass("hide"):n.addClass("hide");for(var a in t)n.find(".mm_data_"+a).html(t[a]);if(n.find(".mm_data_company_name").trunk8("update",t.company_name.replace("Affiliate Program","")),t.company_address&&n.find(".mm_data_company_address").trunk8("update",t.company_address),n.find(".mm_data_offer_name").trunk8("update",t.offer_name),n.find(".mm_data_coupon_code").trunk8("update",t.coupon_code),t.offer_buy_url?(n.find(".mm-shop-now-btn, .mm_data_company_name").attr("mm-href",t.offer_buy_url),n.find(".mm_data_company_name").addClass("mm-active-link").end().find(".mm-shop-now-btn").removeClass("hide"),"No coupons"!=t.coupon_code&&n.find(".mm_data_coupon_code").addClass("mm-active-link").end().find(".mm_data_company_name, .mm_data_coupon_code, .mm-shop-now-btn").attr("mm-href-popup",t.company_coupons_url)):isMobile()?(n.find(".mm-call-now-btn").attr("href","tel:"+t.company_phone),n.find(".mm-call-now-btn").removeClass("hide").html(t.company_phone)):(n.find(".mm-call-now-btn").attr({tooltip:t.company_phone}),n.find(".mm-call-now-btn").removeClass("hide").html("view number")),!isNaN(t.user_money)){var o=parseFloat(t.user_money);n.find(".mm_data_user_money").html(formatMoney(o))}n.find("[mm-href], .mm-call-now-btn").attr("mm-merchant-id",t.id)}},MMBoxWidget.prototype.calculateTotalMoney=function(){for(var e=0,t=0;t<this.currentData.length;t++){var i=this.currentData[t];isNaN(i.user_money)||(e+=parseFloat(i.user_money))}$("#mm-total-money").html("Your Cash Total: "+formatMoney(e))},MMBoxWidget.prototype.showMoreOffers=function(){this.isExpanded=!this.isExpanded,$("#mm-next-offers-label").text(this.isExpanded?"Show Less":"More Deals"),this.buildListings()},MMBoxWidget.prototype.getCurrentData=function(){return this.currentData},MMBoxWidget.prototype.getSearchString=function(){return this.currentSearchText},MMBoxWidget.prototype.onUserLoggedIn=function(e){$("#mm_user_balance").html(formatMoney(e.balance)),$("#mm_user_score").html(e.score),$("#mm-box-controls-logged-in").removeClass("hide"),$("#mm-box-controls-not-logged-in").addClass("hide")},MMBoxWidget.prototype.onUserLoggedOut=function(){this.currentXhr&&this.currentXhr.abort(),this.messages=[],$("#mm-box-message-container").slideUp(),$("#mm_user_score").html("--"),$("#mm-box-controls-logged-in").addClass("hide"),$("#mm-box-controls-not-logged-in").removeClass("hide"),this.currentSearchText="",this.clearResults()},MMIconsWidget.prototype.bindListeners=function(){var e=$.proxy(function(){this.isPopupVisible()&&this.setNextOffer(null)},this);$(".mm-popup-next-offer").click(e),isMobile()&&$(window).on("shake",e)},MMIconsWidget.prototype.isPopupVisible=function(){return 0==$("#mm-offer-modal").is(":hidden")},MMIconsWidget.prototype.setNextOffer=function(e){var t=this.engine.get("box","getCurrentData");this.currentOfferIndex=this.currentOfferIndex>t.length-1?0:this.currentOfferIndex;for(var i in t){var n="Search::SoleoMerchant"!=t[i].type&&"Search::LocalMerchant"!=t[i].type;if(n)if(e){if(e==t[i].company_name){this.setMerchantData(t[i]),this.currentOfferIndex=i;break}}else if(i>=this.currentOfferIndex){this.setMerchantData(t[i]),this.currentOfferIndex=i;break}}this.currentOfferIndex++},MMIconsWidget.prototype.setSearchEngineLinkContainers=function(e){this.searchEngineLinkContainers=e,this.engine.isUserLoggedIn&&null!=this.searchEngineLinkContainers&&(this.clearResults(),this.loadMerchantsByUrls())},MMIconsWidget.prototype.clearResults=function(){$(".mm-affiliate-icon").remove()},MMIconsWidget.prototype.loadMerchantsByUrls=function(){this.currentXhr&&this.currentXhr.abort();var e=[];this.searchEngineLinkContainers.each(function(){e.push($(this).find("a").attr("href"))});var t=this.engine.get("box","getSearchString");this.currentXhr=$.get(this.engine.urlFor("/mm_affiliate_merchants_search"),$.param({links:e,search:t}),$.proxy(function(e){this.onMerchantsByUrlsDataLoaded(e),this.currentXhr=null},this))},MMIconsWidget.prototype.onMerchantsByUrlsDataLoaded=function(e){for(var t=[],i=0;i<e.length;i++)e[i]&&(t.push(e[i]),this.insertMerchantIcon(i,e[i].company_name));this.engine.dispatch("appendData",t)},MMIconsWidget.prototype.setMerchantData=function(e){var t=$("#mm-offer-modal");for(var i in e)t.find(".mm_data_"+i).html(e[i]);t.find(".mm-popup-shop-now").attr("mm-href",e.offer_buy_url).attr("mm-merchant-id",e.id),"No coupons"!=e.coupon_code?(t.find(".mm_data_coupon_code").addClass("mm-active-link"),t.find(".mm-popup-shop-now, .mm_data_coupon_code").attr("mm-href-popup",e.company_coupons_url)):(t.find(".mm_data_coupon_code").removeClass("mm-active-link"),t.find(".mm-popup-shop-now, .mm_data_coupon_code").removeAttr("mm-href-popup"))},MMIconsWidget.prototype.insertMerchantIcon=function(e,t){var i=$("<div/>",{"class":"mm-affiliate-icon","data-toggle":"modal",href:"#mm-offer-modal"});$(this.searchEngineLinkContainers[e]).prepend(i),i.click($.proxy(function(){this.setNextOffer(t)},this))},MMIconsWidget.prototype.onUserLoggedOut=function(){this.currentXhr&&this.currentXhr.abort(),this.searchEngineLinkContainers=null,this.clearResults()},MMEngine.prototype.urlFor=function(e){return this.BASE_URL+e},MMEngine.prototype.getMMBox=function(){return this.widgets.box.widget},MMEngine.prototype.bindListeners=function(){var e=this;$("#mm-auth-form").bind("ajax:success",$.proxy(function(e,t){$(".mm-modal-messages").empty(),t.message?t.success?$("#mm-auth-messages").html(t.message):$("#mm-auth-errors").html(t.message):$("#mm-auth-modal").modal("hide")},this)).bind("ajax:error",function(e,t){$(".mm-modal-messages").empty(),$("#mm-auth-errors").html(t.responseText)}),$("[mm-href]").live("click",function(t){t.preventDefault(),e.currentMerchantId=$(this).attr("mm-merchant-id"),e.currentShoppingHref=$(this).attr("mm-href"),e.skipInfoBeforeShopping?$(".mm-continue-shopping-button").click():($("#mm-info-display").attr("checked",!1),$("#mm-info-before-shopping").fadeIn(300))}),$(".mm-continue-shopping-button").click(function(){window.open(e.currentShoppingHref),$.post(e.urlFor("/mm_activate_merchant"),{id:e.currentMerchantId}),$("#mm-info-before-shopping").fadeOut(300)}),$("#mm-info-display").click(function(){$(this).is(":checked")&&(e.skipInfoBeforeShopping=!0)}),$(".mm-call-now-btn").live("click",function(){var t=$(this).attr("mm-merchant-id");$.post(e.urlFor("/mm_activate_merchant"),{id:t})}),$("[mm-href-popup]").live("click",function(e){if(e.preventDefault(),isMobile()){var t=$("#mm-coupons-iframe");t.contents().empty();var i=$("#mm-coupons-modal");t.attr("src",$(this).attr("mm-href-popup")+"?mobile=1"),t.css("height",i.height()),i.modal("show")}else{var n=660,s=$(window).width()+100,a="innerWidth=440,height="+n+",resizable=no,location=no,scrollbars=yes";a+=",left="+s,window.open($(this).attr("mm-href-popup"),"couponsPopup",a)}}),$(".mm-auth-link").click(function(){$(".mm-modal-messages").empty()}),$(".mm-signup-link").click($.proxy(function(){$(".mm-auth-login-part, .mm-auth-preset-part").addClass("hide"),$(".mm-auth-signup-part").removeClass("hide"),$(".mm-auth-button").text("Sign up"),$("#mm-auth-form").attr("action",this.urlFor("/signup/create"))},this)),$(".mm-login-link").click($.proxy(function(){$(".mm-auth-signup-part, .mm-auth-preset-part").addClass("hide"),$(".mm-auth-login-part").removeClass("hide"),$(".mm-auth-button").text("Log in"),$("#mm-auth-form").attr("action",this.urlFor("/login"))},this)),$(".mm-forgot-password-link").click($.proxy(function(){$(".mm-auth-login-part, .mm-auth-signup-part").addClass("hide"),$(".mm-auth-preset-part").removeClass("hide"),$(".mm-auth-button").text("Send"),$("#mm-auth-form").attr("action",this.urlFor("/reset/send"))},this)),$("#mm-auth-form").attr("action",this.urlFor("/login"))},MMEngine.prototype.onUserSessionChanged=function(e){this.isUserLoggedIn=e,this.isUserLoggedIn&&null==this.currentUserInfo&&$.get(this.urlFor("/mm_box_get_current_user"),$.proxy(function(e){this.onUserLoggedIn(e)},this)),!this.isUserLoggedIn&&this.currentUserInfo&&this.onUserLoggedOut()},MMEngine.prototype.onCheckUserMessages=function(e){this.isUserLoggedIn&&void 0!=e&&0!=e&&this.dispatch("onCheckUserMessages")},MMEngine.prototype.onUserLoggedIn=function(e){this.currentUserInfo=e,$("#mm-auth-errors").empty(),$(".mm-search-bar-icon").removeClass("mm-search-bar-icon-not-logged-in").addClass("mm-search-bar-icon-logged-in").removeAttr("data-toggle").attr("data-confirm","MuddleMe: Are you sure you want to sign out?").attr("data-method","delete").attr("href","/logout").attr("title","Sign out"),this.dispatch("onUserLoggedIn",e)},MMEngine.prototype.onUserLoggedOut=function(){this.currentUserInfo=null,this.skipInfoBeforeShopping=!1,$("#mm-info-before-shopping").fadeOut(300);var e=$(".mm-search-bar-icon").removeClass("mm-search-bar-icon-logged-in").addClass("mm-search-bar-icon-not-logged-in").attr("data-toggle","modal").removeAttr("data-method").removeAttr("data-confirm").attr("href","#mm-auth-modal").attr("title","Log in").parent(),t=$(".mm-search-bar-icon:first").clone();e.empty().append(t),this.dispatch("onUserLoggedOut")},MMEngine.prototype.dispatch=function(e,t){for(var i in this.widgets)"function"==typeof this.widgets[i][e]&&this.widgets[i][e](t)},MMEngine.prototype.get=function(e,t,i){return this.widgets[e]&&"function"==typeof this.widgets[e][t]?this.widgets[e][t](i):null};