function MMBoxWidget(e){this.engine=e,this.numListingsToDisplay=$(".mm-listing").length,this.currentSearchText="",this.currentPage=0,this.currentData=[],this.widget=$("#mm-box-container"),this.listingsTable=$(".mm-listings"),this.currentXhr=null,this.bindListeners()}MMBoxWidget.prototype.bindListeners=function(){$("#mm-next-offers-btn").click($.proxy(function(){this.showNextOffers()},this)),$(".mm_data_company_name").trunk8(),$(".mm_data_company_address").trunk8(),$(".mm_data_offer_name").trunk8({lines:2}),$(".mm_data_coupon_code").trunk8({width:10}),$(".mm-call-now-btn").tipsy({title:"tooltip"})},MMBoxWidget.prototype.clearResults=function(){this.currentPage=0,this.currentData=[],this.listingsTable.fadeOut()},MMBoxWidget.prototype.setSearchText=function(e){this.engine.isUserLoggedIn()&&""!=e&&e!=this.currentSearchText&&(this.clearResults(),this.currentSearchText=e,this.loadMerchantsData())},MMBoxWidget.prototype.loadMerchantsData=function(){this.currentXhr&&this.currentXhr.abort(),this.currentXhr=$.get("/mm_box_search",{search:this.currentSearchText},$.proxy(function(e){this.appendData(e,!0),this.currentXhr=null},this))},MMBoxWidget.prototype.appendData=function(e,t){this.currentData=t?e.concat(this.currentData):this.currentData.concat(e),this.currentData=uniqueBy(this.currentData,function(e){return e.company_name}),this.currentData.length&&(this.listingsTable.fadeIn(),this.buildCurrentPage())},MMBoxWidget.prototype.buildCurrentPage=function(){for(var e=0,t=0;t<this.numListingsToDisplay;t++){var i=this.currentData[t+this.currentPage*this.numListingsToDisplay],n=$("#mm-listing-"+t);if(i){n.removeClass("hide").find("[mm-href]").removeAttr("mm-href").end().find("[mm-href-popup]").removeAttr("mm-href-popup"),n.find(".mm-active-link").removeClass("mm-active-link").end().find(".mm-call-now-btn, .mm-shop-now-btn").addClass("hide");for(var s in i)n.find(".mm_data_"+s).html(i[s]);if(n.find(".mm_data_company_name").trunk8("update",i.company_name.replace("Affiliate Program","")),i.company_address&&n.find(".mm_data_company_address").trunk8("update",i.company_address),n.find(".mm_data_offer_name").trunk8("update",i.offer_name),n.find(".mm_data_coupon_code").trunk8("update",i.coupon_code),i.offer_buy_url?(n.find(".mm-shop-now-btn, .mm_data_company_name").attr("mm-href",i.offer_buy_url),n.find(".mm_data_company_name").addClass("mm-active-link").end().find(".mm-shop-now-btn").removeClass("hide"),"No coupons"!=i.coupon_code&&n.find(".mm_data_coupon_code").addClass("mm-active-link").end().find(".mm_data_company_name, .mm_data_coupon_code, .mm-shop-now-btn").attr("mm-href-popup",i.company_coupons_url)):n.find(".mm-call-now-btn").attr({tooltip:i.company_phone}).html(i.company_phone).removeClass("hide"),!isNaN(i.user_money)){var a=parseFloat(i.user_money);e+=a,n.find(".mm_data_user_money").html(formatMoney(a))}}else n.addClass("hide")}$("#mm-total-money").html("Total: "+formatMoney(e))},MMBoxWidget.prototype.showNextOffers=function(){this.currentPage++,this.currentPage=this.currentData.length/this.numListingsToDisplay<=this.currentPage?0:this.currentPage,this.buildCurrentPage()},MMBoxWidget.prototype.getCurrentData=function(){return this.currentData},MMBoxWidget.prototype.onUserLoggedIn=function(e){$("#mm_user_balance").html(formatMoney(e.balance)),$("#mm_user_score").removeClass("mm-user-score-small").html(e.score),$("#mm-box-controls-logged-in").removeClass("hide"),$("#mm-box-controls-not-logged-in").addClass("hide")},MMBoxWidget.prototype.onUserLoggedOut=function(){$("#mm_user_score").addClass("mm-user-score-small").html("N/A"),$("#mm-box-controls-logged-in").addClass("hide"),$("#mm-box-controls-not-logged-in").removeClass("hide"),this.currentSearchText="",this.clearResults()};