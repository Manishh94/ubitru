function MMBoxWidget(e){this.engine=e,this.messages=[],this.numListingsToDisplay=$(".mm-listing").length,this.currentSearchText="",this.currentPage=0,this.currentData=[],this.widget=$("#mm-box-container"),this.listingsTable=$(".mm-listings"),this.currentXhr=null,$("#mm-info-before-shopping").center(),this.bindListeners()}MMBoxWidget.prototype.bindListeners=function(){var e=this;$(".mm_data_company_name").trunk8(),$(".mm_data_company_address").trunk8(),$(".mm_data_offer_name").trunk8({lines:2}),$(".mm_data_coupon_code").trunk8({width:10}),isMobile()||$(".mm-call-now-btn").tipsy({title:"tooltip"});var t=$.proxy(function(){this.engine.get("icons","isPopupVisible")||this.showNextOffers()},this);$("#mm-next-offers-btn").click(t),$("#mm-clear-message-button").click(function(){$.post(e.engine.urlFor("/mm_box_remove_user_message"),{id:e.messages[0].id},function(t){t&&(e.messages.shift(),e.messages.length>0?$("#mm-current-message").html(e.messages[0].message):$("#mm-box-message-container").slideUp())})}),isMobile()&&$(window).on("shake",t)},MMBoxWidget.prototype.clearResults=function(){this.currentPage=0,this.currentData=[],this.listingsTable.fadeOut()},MMBoxWidget.prototype.onCheckUserMessages=function(){0==this.messages.length&&$.get(this.engine.urlFor("/mm_box_get_user_messages"),$.proxy(function(e){if(e&&e.length){this.messages=e,console.log(this.messages);var t=$("#mm-box-message-container");t.is(":hidden")&&($("#mm-current-message").html(this.messages[0].message),t.slideDown())}},this))},MMBoxWidget.prototype.setSearchText=function(e){this.engine.isUserLoggedIn&&""!=e&&e!=this.currentSearchText&&(this.clearResults(),this.currentSearchText=e,this.loadMerchantsData())},MMBoxWidget.prototype.loadMerchantsData=function(){this.currentXhr&&this.currentXhr.abort(),this.currentXhr=$.get(this.engine.urlFor("/mm_box_search"),{search:this.currentSearchText},$.proxy(function(e){this.appendData(e,!0),this.currentXhr=null},this))},MMBoxWidget.prototype.appendData=function(e,t){this.currentData=t?e.concat(this.currentData):this.currentData.concat(e),this.currentData=uniqueBy(this.currentData,function(e){return e.company_name}),this.currentData.length&&(this.listingsTable.fadeIn(),this.buildCurrentPage(),this.calculateTotalMoney())},MMBoxWidget.prototype.buildCurrentPage=function(){for(var e=0;e<this.numListingsToDisplay;e++){var t=this.currentData[e+this.currentPage*this.numListingsToDisplay],i=$("#mm-listing-"+e);if(t){i.removeClass("hide").find("[mm-href]").removeAttr("mm-href").end().find("[mm-href-popup]").removeAttr("mm-href-popup"),i.find(".mm-active-link").removeClass("mm-active-link").end().find(".mm-call-now-btn, .mm-shop-now-btn").addClass("hide");for(var n in t)i.find(".mm_data_"+n).html(t[n]);if(i.find(".mm_data_company_name").trunk8("update",t.company_name.replace("Affiliate Program","")),t.company_address&&i.find(".mm_data_company_address").trunk8("update",t.company_address),i.find(".mm_data_offer_name").trunk8("update",t.offer_name),i.find(".mm_data_coupon_code").trunk8("update",t.coupon_code),t.offer_buy_url?(i.find(".mm-shop-now-btn, .mm_data_company_name").attr("mm-href",t.offer_buy_url),i.find(".mm_data_company_name").addClass("mm-active-link").end().find(".mm-shop-now-btn").removeClass("hide"),"No coupons"!=t.coupon_code&&i.find(".mm_data_coupon_code").addClass("mm-active-link").end().find(".mm_data_company_name, .mm_data_coupon_code, .mm-shop-now-btn").attr("mm-href-popup",t.company_coupons_url)):(isMobile()?i.find(".mm-call-now-btn").attr("href","tel:"+t.company_phone).html(t.company_phone):i.find(".mm-call-now-btn").attr({tooltip:t.company_phone}).html("view number"),i.find(".mm-call-now-btn").removeClass("hide")),!isNaN(t.user_money)){var s=parseFloat(t.user_money);i.find(".mm_data_user_money").html(formatMoney(s))}i.find("[mm-href], .mm-call-now-btn").attr("mm-merchant-id",t.id)}else i.addClass("hide")}},MMBoxWidget.prototype.calculateTotalMoney=function(){for(var e=0,t=0;t<this.currentData.length;t++){var i=this.currentData[t];isNaN(i.user_money)||(e+=parseFloat(i.user_money))}$("#mm-total-money").html("Your Cash Total: "+formatMoney(e))},MMBoxWidget.prototype.showNextOffers=function(){this.currentPage++,this.currentPage=this.currentData.length/this.numListingsToDisplay<=this.currentPage?0:this.currentPage,this.buildCurrentPage()},MMBoxWidget.prototype.getCurrentData=function(){return this.currentData},MMBoxWidget.prototype.getSearchString=function(){return this.currentSearchText},MMBoxWidget.prototype.onUserLoggedIn=function(e){$("#mm_user_balance").html(formatMoney(e.balance)),$("#mm_user_score").removeClass("mm-user-score-small").html(e.score),$("#mm-box-controls-logged-in").removeClass("hide"),$("#mm-box-controls-not-logged-in").addClass("hide")},MMBoxWidget.prototype.onUserLoggedOut=function(){this.currentXhr&&this.currentXhr.abort(),this.messages=[],$("#mm-box-message-container").slideUp(),$("#mm_user_score").addClass("mm-user-score-small").html("N/A"),$("#mm-box-controls-logged-in").addClass("hide"),$("#mm-box-controls-not-logged-in").removeClass("hide"),this.currentSearchText="",this.clearResults()};