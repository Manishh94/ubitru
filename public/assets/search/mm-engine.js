function MMEngine(t,e,i,n){this.BASE_URL=t||"",this.currentUserInfo=e,this.isUserLoggedIn=null!=e;var s=$(".mm-search-bar-icon").addClass(n).removeClass("hide");$("."+i).each($.proxy(function(t,e){$(e).append(t?s.clone():s)},this)),this.bindListeners(),this.widgets={box:new MMBoxWidget(this),icons:new MMIconsWidget(this)},this.currentMerchantId=null,this.currentShoppingHref=null}MMEngine.prototype.urlFor=function(t){return this.BASE_URL+t},MMEngine.prototype.getMMBox=function(){return this.widgets.box.widget},MMEngine.prototype.bindListeners=function(){var t=this;$("#mm-auth-form").bind("ajax:success",$.proxy(function(t,e){$(".mm-modal-messages").empty(),e.message?e.success?$("#mm-auth-messages").html(e.message):$("#mm-auth-errors").html(e.message):$("#mm-auth-modal").modal("hide")},this)).bind("ajax:error",function(t,e){$(".mm-modal-messages").empty(),$("#mm-auth-errors").html(e.responseText)}),$("[mm-href]").live("click",function(e){e.preventDefault(),t.currentMerchantId=$(this).attr("mm-merchant-id"),t.currentShoppingHref=$(this).attr("mm-href"),t.currentUserInfo.skip_info_before_shopping?$(".mm-continue-shopping-button").click():($("#mm-info-display").attr("checked",!1),$("#mm-info-before-shopping").fadeIn(300))}),$(".mm-continue-shopping-button").click(function(){window.open(t.currentShoppingHref),$.post(t.urlFor("/mm_activate_merchant"),{id:t.currentMerchantId}),$("#mm-info-before-shopping").fadeOut(300)}),$("#mm-info-display").click(function(){$(this).is(":checked")&&(t.currentUserInfo.skip_info_before_shopping=!0,$.post(t.urlFor("/mm_skip_info_before_shopping")))}),$(".mm-call-now-btn").live("click",function(){var e=$(this).attr("mm-merchant-id");$.post(t.urlFor("/mm_activate_merchant"),{id:e})}),$("[mm-href-popup]").live("click",function(t){if(t.preventDefault(),isMobile()){var e=$("#mm-coupons-iframe");e.contents().empty();var i=$("#mm-coupons-modal");e.attr("src",$(this).attr("mm-href-popup")+"?mobile=1"),e.css("height",i.height()),i.modal("show")}else{var n=660,s=$(window).width()+100,o="innerWidth=440,height="+n+",resizable=no,location=no,scrollbars=yes";o+=",left="+s,window.open($(this).attr("mm-href-popup"),"couponsPopup",o)}}),$(".mm-auth-link").click(function(){$(".mm-modal-messages").empty()}),$(".mm-signup-link").click($.proxy(function(){$(".mm-auth-login-part, .mm-auth-preset-part").addClass("hide"),$(".mm-auth-signup-part").removeClass("hide"),$(".mm-auth-button").text("Sign up"),$("#mm-auth-form").attr("action",this.urlFor("/signup/create"))},this)),$(".mm-login-link").click($.proxy(function(){$(".mm-auth-signup-part, .mm-auth-preset-part").addClass("hide"),$(".mm-auth-login-part").removeClass("hide"),$(".mm-auth-button").text("Log in"),$("#mm-auth-form").attr("action",this.urlFor("/login"))},this)),$(".mm-forgot-password-link").click($.proxy(function(){$(".mm-auth-login-part, .mm-auth-signup-part").addClass("hide"),$(".mm-auth-preset-part").removeClass("hide"),$(".mm-auth-button").text("Send"),$("#mm-auth-form").attr("action",this.urlFor("/reset/send"))},this)),$("#mm-auth-form").attr("action",this.urlFor("/login"))},MMEngine.prototype.onUserSessionChanged=function(t){this.isUserLoggedIn=t,this.isUserLoggedIn&&null==this.currentUserInfo&&$.get(this.urlFor("/mm_box_get_current_user"),$.proxy(function(t){this.onUserLoggedIn(t)},this)),!this.isUserLoggedIn&&this.currentUserInfo&&this.onUserLoggedOut()},MMEngine.prototype.onCheckUserMessages=function(t){this.isUserLoggedIn&&void 0!=t&&0!=t&&this.dispatch("onCheckUserMessages")},MMEngine.prototype.onUserLoggedIn=function(t){this.currentUserInfo=t,$("#mm-auth-errors").empty(),$(".mm-search-bar-icon").removeClass("mm-search-bar-icon-not-logged-in").addClass("mm-search-bar-icon-logged-in").removeAttr("data-toggle").attr("data-confirm","MuddleMe: Are you sure you want to sign out?").attr("data-method","delete").attr("href","/logout").attr("title","Sign out"),this.dispatch("onUserLoggedIn",t)},MMEngine.prototype.onUserLoggedOut=function(){this.currentUserInfo=null,$("#mm-info-before-shopping").fadeOut(300);var t=$(".mm-search-bar-icon").removeClass("mm-search-bar-icon-logged-in").addClass("mm-search-bar-icon-not-logged-in").attr("data-toggle","modal").removeAttr("data-method").removeAttr("data-confirm").attr("href","#mm-auth-modal").attr("title","Log in").parent(),e=$(".mm-search-bar-icon:first").clone();t.empty().append(e),this.dispatch("onUserLoggedOut")},MMEngine.prototype.dispatch=function(t,e){for(var i in this.widgets)"function"==typeof this.widgets[i][t]&&this.widgets[i][t](e)},MMEngine.prototype.get=function(t,e,i){return this.widgets[t]&&"function"==typeof this.widgets[t][e]?this.widgets[t][e](i):null};