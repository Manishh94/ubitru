/*
 * jQuery File Upload User Interface Plugin 6.5.4
 * https://github.com/blueimp/jQuery-File-Upload
 *
 * Copyright 2010, Sebastian Tschan
 * https://blueimp.net
 *
 * Licensed under the MIT license:
 * http://www.opensource.org/licenses/MIT
 */
!function(t){"use strict";"function"==typeof define&&define.amd?define(["jquery","./tmpl.js","./load-image.js","./jquery.fileupload-ip.js"],t):t(window.jQuery,window.tmpl,window.loadImage)}(function(t,e,i){"use strict";t.widget("blueimpUI.fileupload",t.blueimpIP.fileupload,{options:{autoUpload:!1,maxNumberOfFiles:void 0,maxFileSize:void 0,minFileSize:void 0,acceptFileTypes:/.+$/i,previewSourceFileTypes:/^image\/(gif|jpeg|png)$/,previewSourceMaxFileSize:5e6,previewMaxWidth:80,previewMaxHeight:80,previewAsCanvas:!0,uploadTemplateId:"template-upload",downloadTemplateId:"template-download",dataType:"json",add:function(e,i){var n=t(this).data("fileupload"),s=n.options,o=i.files;n._adjustMaxNumberOfFiles(-o.length),i.isAdjusted=!0,t(this).fileupload("resize",i).done(i,function(){i.files.valid=i.isValidated=n._validate(o),i.context=n._renderUpload(o).appendTo(n._files).data("data",i),n._renderPreviews(o,i.context),n._reflow=t.support.transition&&i.context[0].offsetWidth,n._transition(i.context).done(function(){n._trigger("added",e,i)!==!1&&(s.autoUpload||i.autoUpload)&&i.autoUpload!==!1&&i.isValidated&&i.submit()})})},send:function(e,i){var n=t(this).data("fileupload");return i.isValidated||(i.isAdjusted||n._adjustMaxNumberOfFiles(-i.files.length),n._validate(i.files))?(i.context&&i.dataType&&"iframe"===i.dataType.substr(0,6)&&i.context.find(".progress").addClass(!t.support.transition&&"progress-animated").find(".bar").css("width",parseInt(100,10)+"%"),n._trigger("sent",e,i)):!1},done:function(e,i){var n,s=t(this).data("fileupload");i.context?i.context.each(function(o){var a=t.isArray(i.result)&&i.result[o]||{error:"emptyResult"};a.error&&s._adjustMaxNumberOfFiles(1),s._transition(t(this)).done(function(){var o=t(this);n=s._renderDownload([a]).css("height",o.height()).replaceAll(o),s._reflow=t.support.transition&&n[0].offsetWidth,s._transition(n).done(function(){i.context=t(this),s._trigger("completed",e,i)})})}):(n=s._renderDownload(i.result).appendTo(s._files),s._reflow=t.support.transition&&n[0].offsetWidth,s._transition(n).done(function(){i.context=t(this),s._trigger("completed",e,i)}))},fail:function(e,i){var n,s=t(this).data("fileupload");s._adjustMaxNumberOfFiles(i.files.length),i.context?i.context.each(function(o){if("abort"!==i.errorThrown){var a=i.files[o];a.error=a.error||i.errorThrown||!0,s._transition(t(this)).done(function(){var o=t(this);n=s._renderDownload([a]).replaceAll(o),s._reflow=t.support.transition&&n[0].offsetWidth,s._transition(n).done(function(){i.context=t(this),s._trigger("failed",e,i)})})}else s._transition(t(this)).done(function(){t(this).remove(),s._trigger("failed",e,i)})}):"abort"!==i.errorThrown?(s._adjustMaxNumberOfFiles(-i.files.length),i.context=s._renderUpload(i.files).appendTo(s._files).data("data",i),s._reflow=t.support.transition&&i.context[0].offsetWidth,s._transition(i.context).done(function(){i.context=t(this),s._trigger("failed",e,i)})):s._trigger("failed",e,i)},progress:function(t,e){e.context&&e.context.find(".progress .bar").css("width",parseInt(100*(e.loaded/e.total),10)+"%")},progressall:function(e,i){t(this).find(".fileupload-buttonbar .progress .bar").css("width",parseInt(100*(i.loaded/i.total),10)+"%")},start:function(e){var i=t(this).data("fileupload");i._transition(t(this).find(".fileupload-buttonbar .progress")).done(function(){i._trigger("started",e)})},stop:function(e){var i=t(this).data("fileupload");i._transition(t(this).find(".fileupload-buttonbar .progress")).done(function(){t(this).find(".bar").css("width","0%"),i._trigger("stopped",e)})},destroy:function(e,i){var n=t(this).data("fileupload");i.url&&t.ajax(i),n._adjustMaxNumberOfFiles(1),n._transition(i.context).done(function(){t(this).remove(),n._trigger("destroyed",e,i)})}},_enableDragToDesktop:function(){var e=t(this),i=e.prop("href"),n=e.prop("download"),s="application/octet-stream";e.bind("dragstart",function(t){try{t.originalEvent.dataTransfer.setData("DownloadURL",[s,n,i].join(":"))}catch(e){}})},_adjustMaxNumberOfFiles:function(t){"number"==typeof this.options.maxNumberOfFiles&&(this.options.maxNumberOfFiles+=t,this.options.maxNumberOfFiles<1?this._disableFileInputButton():this._enableFileInputButton())},_formatFileSize:function(t){return"number"!=typeof t?"":t>=1e9?(t/1e9).toFixed(2)+" GB":t>=1e6?(t/1e6).toFixed(2)+" MB":(t/1e3).toFixed(2)+" KB"},_hasError:function(t){return t.error?t.error:this.options.maxNumberOfFiles<0?"maxNumberOfFiles":this.options.acceptFileTypes.test(t.type)||this.options.acceptFileTypes.test(t.name)?this.options.maxFileSize&&t.size>this.options.maxFileSize?"maxFileSize":"number"==typeof t.size&&t.size<this.options.minFileSize?"minFileSize":null:"acceptFileTypes"},_validate:function(e){var i=this,n=!!e.length;return t.each(e,function(t,e){e.error=i._hasError(e),e.error&&(n=!1)}),n},_renderTemplate:function(e,i){return t(this.options.templateContainer).html(e({files:i,formatFileSize:this._formatFileSize,options:this.options})).children()},_renderPreview:function(e,n){var s=this,o=this.options,a=t.Deferred();return(i(e,function(e){n.append(e),s._reflow=t.support.transition&&n[0].offsetWidth,s._transition(n).done(function(){a.resolveWith(n)})},{maxWidth:o.previewMaxWidth,maxHeight:o.previewMaxHeight,canvas:o.previewAsCanvas})||a.resolveWith(n))&&a},_renderPreviews:function(e,i){var n=this,s=this.options;return i.find(".preview span").each(function(i,o){var a=e[i];s.previewSourceFileTypes.test(a.type)&&("number"!==t.type(s.previewSourceMaxFileSize)||a.size<s.previewSourceMaxFileSize)&&(n._processingQueue=n._processingQueue.pipe(function(){var e=t.Deferred();return n._renderPreview(a,t(o)).done(function(){e.resolveWith(n)}),e.promise()}))}),this._processingQueue},_renderUpload:function(t){return this._renderTemplate(this.options.uploadTemplate,t)},_renderDownload:function(t){return this._renderTemplate(this.options.downloadTemplate,t).find("a[download]").each(this._enableDragToDesktop).end()},_startHandler:function(e){e.preventDefault();var i=t(this),n=i.closest(".template-upload"),s=n.data("data");s&&s.submit&&!s.jqXHR&&s.submit()&&i.prop("disabled",!0)},_cancelHandler:function(e){e.preventDefault();var i=t(this).closest(".template-upload"),n=i.data("data")||{};n.jqXHR?n.jqXHR.abort():(n.errorThrown="abort",e.data.fileupload._trigger("fail",e,n))},_deleteHandler:function(e){e.preventDefault();var i=t(this);e.data.fileupload._trigger("destroy",e,{context:i.closest(".template-download"),url:i.attr("data-url"),type:i.attr("data-type"),dataType:e.data.fileupload.options.dataType})},_transition:function(e){var i=t.Deferred();return t.support.transition&&e.hasClass("fade")?e.bind(t.support.transition.end,function(n){n.target===e[0]&&(e.unbind(t.support.transition.end),i.resolveWith(e))}).toggleClass("in"):(e.toggleClass("in"),i.resolveWith(e)),i},_initButtonBarEventHandlers:function(){var e=this.element.find(".fileupload-buttonbar"),i=this._files,n=this.options.namespace;e.find(".start").bind("click."+n,function(t){t.preventDefault(),i.find(".start button").click()}),e.find(".cancel").bind("click."+n,function(t){t.preventDefault(),i.find(".cancel button").click()}),e.find(".delete").bind("click."+n,function(t){t.preventDefault(),i.find(".delete input:checked").siblings("button").click(),e.find(".toggle").prop("checked",!1)}),e.find(".toggle").bind("change."+n,function(){i.find(".delete input").prop("checked",t(this).is(":checked"))})},_destroyButtonBarEventHandlers:function(){this.element.find(".fileupload-buttonbar button").unbind("click."+this.options.namespace),this.element.find(".fileupload-buttonbar .toggle").unbind("change."+this.options.namespace)},_initEventHandlers:function(){t.blueimpIP.fileupload.prototype._initEventHandlers.call(this);var e={fileupload:this};this._files.delegate(".start button","click."+this.options.namespace,e,this._startHandler).delegate(".cancel button","click."+this.options.namespace,e,this._cancelHandler).delegate(".delete button","click."+this.options.namespace,e,this._deleteHandler),this._initButtonBarEventHandlers()},_destroyEventHandlers:function(){this._destroyButtonBarEventHandlers(),this._files.undelegate(".start button","click."+this.options.namespace).undelegate(".cancel button","click."+this.options.namespace).undelegate(".delete button","click."+this.options.namespace),t.blueimpIP.fileupload.prototype._destroyEventHandlers.call(this)},_enableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!1).parent().removeClass("disabled")},_disableFileInputButton:function(){this.element.find(".fileinput-button input").prop("disabled",!0).parent().addClass("disabled")},_initTemplates:function(){var t=this.options;t.templateContainer=document.createElement(this._files.prop("nodeName")),t.uploadTemplate=e(t.uploadTemplateId),t.downloadTemplate=e(t.downloadTemplateId)},_initFiles:function(){this._files=this.element.find(".files")},_create:function(){this._initFiles(),t.blueimpIP.fileupload.prototype._create.call(this),this._initTemplates()},enable:function(){t.blueimpIP.fileupload.prototype.enable.call(this),this.element.find("input, button").prop("disabled",!1),this._enableFileInputButton()},disable:function(){this.element.find("input, button").prop("disabled",!0),this._disableFileInputButton(),t.blueimpIP.fileupload.prototype.disable.call(this)}})});